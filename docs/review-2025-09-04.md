# Review: 待修复 Bugs 列表（2025-09-04）

说明：以下清单基于当前代码与已知反馈整理。已确认不纳入本次修复范围的项：
- [已修复] 任务在 Task View 中编辑后不更新（原问题 #2）
- [暂不考虑] List View 渲染卡顿（原问题 #4）
- [已在新架构修复] 启动时任务重建漏项（原问题 #7）

以下为仍需修复的问题与建议方案：

## 1) 过滤器输入导致实时加载，Task View 打开时性能大幅下降（原问题 #1）
- 现象：在“视图过滤器”输入每个字符时就触发刷新，造成频繁过滤与重渲染。
- 涉及模块：
  - 过滤器组件事件广播：`src/components/features/task/filter/ViewTaskFilter.ts`（saveStateToLocalStorage → 触发 `task-genius:filter-changed`）
  - TaskView 处理防抖：`src/pages/TaskView.ts`（`debouncedApplyFilter` 当前延时较短）
  - 文本搜索即时刷新：`src/components/features/task/view/content.ts`（`filterTasks`）
- 修复建议：
  - 提高 TaskView 内 `debouncedApplyFilter` 延迟（建议 300–500ms）。
  - 在 ViewTaskFilter 中对输入框 `input` 事件增加本地防抖；或编辑时 `saveStateToLocalStorage(triggerRealtimeUpdate=false)`，提交/失焦时再广播。
  - ContentComponent 的文本搜索同样使用防抖（约 300ms）。
- 验收：连续输入时渲染频率显著下降；大型数据集输入体验流畅，无明显掉帧。

## 2) 视图顺序在设置中调整后，Task View 侧边栏未按顺序展示（原问题 #3）
- 现象：Views & Index 页中上下移动视图后，侧边栏排序不一致。
- 涉及模块：
  - 设置页顺序变更：`src/components/features/settings/tabs/ViewSettingsTab.ts`
  - 侧边栏渲染：`src/components/features/task/view/sidebar.ts`（当前将视图分为默认/自定义/底部组，改变了原始顺序）
- 修复建议：
  - 侧边栏按 `settings.viewConfiguration` 原始顺序渲染（仅过滤 `visible`），不要再额外分组打乱顺序。
  - 若需“底部固定组”（habit/calendar/gantt/kanban），可在设置层面赋予“区域”属性，或在数据层维护顺序一致性。
- 验收：在设置中调整顺序后，侧边栏显示顺序与设置数组一致。

## 3) 编辑包含任务的文件时，Task View 展示的文本出现偏差，需关闭重开才正确（原问题 #5）
- 现象：外部编辑器或 Obsidian 编辑某文件中的任务时，Task View 中对应条目短时间显示不一致内容。
- 涉及模块：
  - 任务缓存更新与视图刷新：`src/pages/TaskView.ts`（监听 `TASK_CACHE_UPDATED`，`debouncedViewUpdate` 刷新）
  - 列表项 Markdown 渲染：`src/components/features/task/view/listItem.ts`（`renderMarkdown` 使用 `task.originalMarkdown`）
- 修复建议：
  - 稳定事件节奏：适度加大 `debouncedViewUpdate` 延迟或合并短时间内的多次更新，避免“半成品”快照进入 UI。
  - 确保外部写入后再触发一次最终刷新（Orchestrator rebuild/快照完成时统一触发视图更新）。
  - 列表项渲染前确保完全清理旧内容（已 empty）并使用最新 `originalMarkdown` 渲染。
- 验收：编辑文件后，无需关闭重开，Task View 即可稳定显示最终内容，无中间错乱。

## 4) 自定义任务视图从分栏（split）模式无法切回单列模式（原问题 #6）
- 现象：编辑自定义视图时，无法从“两列视图”回到“单列视图”。
- 涉及模块：
  - 两列视图基类与切换：`src/components/features/task/view/TwoColumnViewBase.ts`
  - 视图创建/切换：`src/pages/TaskView.ts`（根据 `viewConfig.specificConfig.viewType === "twocolumn"` 决定）
  - 视图配置弹窗：`src/components/features/task/view/modals/ViewConfigModal.ts`
- 修复建议：
  - 在 ViewConfigModal 中暴露“视图布局类型”（single/twocolumn）切换；保存后更新 `viewConfiguration`。
  - TaskView 在 `onSettingsUpdate` 时销毁/隐藏旧的 TwoColumn 组件，恢复常规 ContentComponent，并刷新当前视图。
- 验收：用户可在配置中自由切换布局，保存后侧边栏对应视图正确切换模式。

## 5) 勾选一个习惯时，偶发地所有习惯都被勾选（原问题 #8）
- 现象：点击单个 Habit 打勾，偶发地其它 Habit 也被更新。
- 涉及模块：
  - Habit 勾选入口：`src/components/features/habit/habitcard/habitcard.ts`（`toggleHabitCompletion`）
  - 写回与索引：`src/managers/habit-manager.ts`（`updateHabitInObsidian` 与后续 habit 索引更新）
- 修复建议：
  - 校验 Habit `id` 的唯一性与全链路使用一致；仅更新目标 habit 的 `completions[today]`。
  - 写回模板/标记仅定位目标 habit 片段，避免通配批量替换。
  - 索引更新（map 遍历）中保持纯函数式修改，仅对目标 habit 变动，防止共享引用导致联动。
- 验收：反复勾选单一 Habit，不会影响其它 Habit 的状态。

## 6) Ctrl+K 未能聚焦设置菜单的搜索框（原问题 #9）
- 现象：提示文案包含 “(Ctrl+K)”，但快捷键无法聚焦搜索输入。
- 涉及模块：
  - 设置搜索组件：`src/components/features/settings/components/SettingsSearchComponent.ts`
  - 设置页入口：`src/setting.ts`（创建搜索组件）
- 修复建议：
  - 在 SettingsSearchComponent 内注册全局键盘监听：在 macOS 使用 `metaKey + K`，Windows/Linux 使用 `ctrlKey + K`，触发 `searchInputEl.focus()` 与结果弹出。
  - 或通过 SettingTab 的 Scope 定义快捷键绑定到聚焦行为。
- 验收：在设置页按下 Ctrl/Cmd+K，输入框获得焦点并可立即搜索。

